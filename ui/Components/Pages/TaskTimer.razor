<<<<<<< HEAD
@page "/tasktimer"
=======
ï»¿@page "/tasktimer"
<<<<<<< HEAD
>>>>>>> 6daffb2 (feat: move timer logic to client-side)
=======
@using System.Runtime.InteropServices.JavaScript
>>>>>>> 2263b79 (feat: add JavaScript interop for client-side timer handling)
@rendermode InteractiveServer
@implements IAsyncDisposable
@inject IJSRuntime JS

<PageTitle>Task Timer</PageTitle>

<h3>Task Timer</h3>

<div class="card" style="width: 400px;">
    <div class="card-body">
        <h3 class="card-title">Pomodoro Timer</h3>
        
        @if (IsInitialized)
        {
            <div class="mb-3">
<<<<<<< HEAD
<<<<<<< HEAD
                <p>Remaining Time: @FormatTime(CurrentRemainingTime)</p>
=======
                <p>Remaining Time: @FormatTime(_taskTimer.RemainingTime)</p>
>>>>>>> 6daffb2 (feat: move timer logic to client-side)
=======
                <p>Remaining Time:&nbsp 
                    <span id='timerDisplay'>@FormatTime(_taskTimer.RemainingTime)</span>
                </p>
>>>>>>> 2263b79 (feat: add JavaScript interop for client-side timer handling)
                <p>Current Phase: @(_taskTimer.IsWorkTime ? "Work" : "Break")</p>
                <p>Status: @TimerStatus</p>
            </div>
            
            <button @onclick="StartTimer" id="startTimerBtn" class="btn btn-primary me-2">
                Start
            </button>
            
            <button @onclick="TogglePause" id="togglePauseBtn" class="btn btn-warning">
                @(_taskTimer.IsRunning ? "Pause" : "Resume")
            </button>
        }
    </div>
</div>

@code {
    private Eddy.TaskTimer _taskTimer = new Eddy.TaskTimer(25, 5);
    private bool IsInitialized { get; set; } = false;
    private string TimerStatus { get; set; } = "Idle";
<<<<<<< HEAD
<<<<<<< HEAD
    private double CurrentRemainingTime { get; set; } = 0;
=======
>>>>>>> 6daffb2 (feat: move timer logic to client-side)
=======
    private IJSObjectReference? module;
>>>>>>> 2263b79 (feat: add JavaScript interop for client-side timer handling)

    protected override async Task OnInitializedAsync()
    {
        IsInitialized = true;
<<<<<<< HEAD
<<<<<<< HEAD
        CurrentRemainingTime = _taskTimer.RemainingTime;
=======
        
>>>>>>> 6daffb2 (feat: move timer logic to client-side)
=======

>>>>>>> 2263b79 (feat: add JavaScript interop for client-side timer handling)
        StateHasChanged();

        await Task.Yield();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (module is not null)
        {
            try
            {
                await module.DisposeAsync();
            } catch (JSDisconnectedException)
            {
            }
        }
    }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JS.InvokeAsync<IJSObjectReference>("import",
                "./Components/Pages/TaskTimer.razor.js");

            int[] timeArgs = [_taskTimer.WorkDuration, _taskTimer.BreakDuration];
            await module.InvokeVoidAsync("addHandlers", timeArgs);
        }
    }

    private async Task StartTimer()
    {
        if (!_taskTimer.IsRunning)
        {
            TimerStatus = $"Started {(_taskTimer.IsWorkTime ? "work" : "break")} timer";
<<<<<<< HEAD
<<<<<<< HEAD
            StateHasChanged();

            // Capture the initial remaining time
            CurrentRemainingTime = _taskTimer.RemainingTime;
            
            await _taskTimer.StartAsync().ConfigureAwait(false);
            
            // Update UI while timer runs
            while (_taskTimer.IsRunning)
            {
                CurrentRemainingTime = _taskTimer.RemainingTime;
                StateHasChanged();
                await Task.Delay(100); // Update every 100ms
            }
            
            // Final update when timer completes
            CurrentRemainingTime = _taskTimer.RemainingTime;
            StateHasChanged();
=======
            await JSRuntime.InvokeVoidAsync("startTimer", _taskTimer.RemainingTime);
>>>>>>> 6daffb2 (feat: move timer logic to client-side)
=======
>>>>>>> 2263b79 (feat: add JavaScript interop for client-side timer handling)
        }

        await _taskTimer.StartAsync().ConfigureAwait(false);
    }

    private void TogglePause()
    {
        _taskTimer.TogglePause();
<<<<<<< HEAD
        TimerStatus = _taskTimer.IsRunning ? "Paused" : "Resumed";
<<<<<<< HEAD
        StateHasChanged();
=======
>>>>>>> 6daffb2 (feat: move timer logic to client-side)
=======
        TimerStatus = _taskTimer.IsRunning ? "Resumed": "Paused";
>>>>>>> 2263b79 (feat: add JavaScript interop for client-side timer handling)
    }

    private string FormatTime(double seconds)
    {
        int minutes = (int)(seconds / 60);
        int remainingSeconds = (int)Math.Floor(seconds % 60);
        
        return $"{minutes:D2}:{remainingSeconds:D2}";
    }
}
