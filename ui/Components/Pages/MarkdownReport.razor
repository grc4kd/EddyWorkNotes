@page "/worknotesmd"
@using System.Text
@using DataEntities.Interfaces
@using ui.Components.Validators
@using Markdig

@inject IWorkNoteRepository WorkNoteRepository

<PageTitle>Markdown Report</PageTitle>

<h3>Markdown Report</h3>

@if (_isLoading)
{
    <p>Loading work notes...</p>
}
else if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">
        @_error
    </div>
}
else if (string.IsNullOrEmpty(_markdownPreview))
{
    <p>No work notes found for the last 16 hours or current date.</p>
}
else
{
    <div class="markdown-report">
        <h4>Work Notes</h4>
        <div class="report-content">
            @((MarkupString)_markdownPreview)
        </div>
    </div>
}

<style>
    .markdown-report {
        margin: 20px 0;
    }

    .report-content {
        border: 1px solid #ccc;
        padding: 15px;
        background-color: #f9f9f9;
        white-space: normal;
    }
</style>

@code {
    private string _markdownPreview = string.Empty;
    private bool _isLoading = true;
    private string _error = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;

            // Get work notes from the last 16 hours or current date
            var sixteenHoursAgo = DateTime.UtcNow.AddHours(-16);
            var workNotes = await WorkNoteRepository.GetWorkNotesSince(sixteenHoursAgo);

            // Concatenate all descriptions
            var sb = new StringBuilder();
            foreach (var note in workNotes.Where(note => !string.IsNullOrWhiteSpace(note.Description)))
            {
                sb.Append("### Date/Time: ");
                sb.AppendLine(note.RecordedAtTimeUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss"));
                sb.AppendLine();
                sb.AppendLine(MarkdownValidator.SanitizeMarkdown(note.Description ?? string.Empty));
                sb.AppendLine();
                sb.AppendLine("---");
                sb.AppendLine();
            }

            var markdownContent = sb.ToString().Trim();

            // Use Markdig to render Markdown to HTML
            var pipeline = new MarkdownPipelineBuilder()
                .UseAdvancedExtensions()
                .Build();

            _markdownPreview = Markdown.ToHtml(markdownContent, pipeline);
        }
        catch (Exception ex)
        {
            _error = $"Error loading work notes: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

}